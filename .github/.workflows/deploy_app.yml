name: Deploy apps
"on":
    push:
        branches:
            - "main"
jobs:
    deploy-macos:
        if: ${{ contains(github.event.head_commit.message, 'version') }}
        runs-on: macos-latest
        env:
            MACOS_APP_RELEASE_PATH: build/macos/Build/Products/Release
        steps:
            - name: Close repository
              uses: actions/checkout@v4
            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: main
                  flutter-version: 1be51f8
            - run: flutter --version
            - name: Build macOS app
              run: flutter build macos --release
            - name: Codesign executable
              env:
                  MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
                  MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
                  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
              run: |
                  echo $MACOS_CERTIFICATE | base64 --decode > certificate.p12
                  echo "Create Keychain"
                  security create-keychain -p $KEYCHAIN_PASSWORD build.keychain
                  echo "Assign to Login Keychain"
                  security default-keychain -s build.keychain
                  echo "Unlock the Login Keychain"
                  security unlock-keychain -p $KEYCHAIN_PASSWORD build.keychain
                  echo "Import certificate"
                  security import certificate.p12 -k build.keychain -P $MACOS_CERTIFICATE_PWD -T /usr/bin/codesign
                  echo "Set Key Partition"
                  security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k $KEYCHAIN_PASSWORD build.keychain
                  echo "Find Identity"
                  security find-identity
                  echo "Sign the app"
                  /usr/bin/codesign --force --deep -s 3GUG43SZ6J ./$MACOS_APP_RELEASE_PATH/example.app
            - name: Create a dmg
              run: |
                  echo "Install create-dmg"
                  brew install create-dmg
                  cd $MACOS_APP_RELEASE_PATH
                  create-dmg \
                      --volname "Visir" \
                      --window-pos 200 120 \
                      --window-size 800 529 \
                      --icon-size 130 \
                      --text-size 14 \
                      --icon "example.app" 260 250 \
                      --hide-extension "example.app" \
                      --app-drop-link 540 250 \
                      --hdiutil-quiet \
                      "Visir.dmg" \
                      "example.app"
            - name: Create Version Number
              id: versions
              run: |
                  git fetch
                  VERSION_WITHOUT_SUFFIX="$(grep 'version:' pubspec.yaml | awk '{ print $2 }')"
                  function parse_git_hash() {
                      git rev-list --count origin/main
                  }
                  MAIN_COUNT=$(parse_git_hash)
                  APP_VERSION="$VERSION_WITHOUT_SUFFIX:$MAIN_COUNT"
                  echo "::set-output name=version::$(echo $APP_VERSION)"
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.versions.outputs.version }}
                  release_name: Release ${{ steps.versions.outputs.version }}
                  body: |
                      Release Notes
                  draft: false
                  prerelease: false
            - name: Upload Release Asset
              id: upload-release-asset
              uses: AButler/upload-release-assets@v3.0
              with:
                  files: build/macos/Build/Products/Release/Visir.dmg
                  repo-token: ${{ secrets.GITHUB_TOKEN }}
    deploy-ios:
        if: ${{ contains(github.event.head_commit.message, 'version') }}
        runs-on: macos-latest
        steps:
            - name: Close repository
              uses: actions/checkout@v4
            - name: Set up Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
            - run: flutter --version

            # Install the Apple certificate and provisioning profile
            - name: Install the Apple certificate and provisioning profile
              env:
                  BUILD_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE }}
                  P12_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
                  BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
                  KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
              run: |
                  # create variables
                  CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
                  PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
                  KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
                  # import certificate and provisioning profile from secrets
                  echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
                  echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH
                  # create temporary keychain
                  security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
                  security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
                  security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
                  # import certificate to keychain
                  security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
                  security list-keychain -d user -s $KEYCHAIN_PATH
                  # apply provisioning profile
                  mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
                  cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

            # Build and sign the ipa using a single flutter command
            - name: Building IPA
              run: flutter build ipa --release --no-codesign

            - uses: bradyjoslin/ios-resign-action@v1
              with:
                  ipa_path: build/ios/ipa/*.ipa
                  mobileprovision: ${{ secrets.MOBILEPROVISION_BASE64 }}
                  cert_p12: ${{ secrets.MACOS_CERTIFICATE }}
                  p12_pass: ${{ secrets.MACOS_CERTIFICATE_PWD }}
                  signing_identity: ${{ secrets.SIGNING_IDENTITY }}

            # Collect the file and upload as artifact
            - name: collect ipa artifacts
              uses: actions/upload-artifact@v2
              with:
                  name: release-ipa
                  path: build/ios/ipa/*.ipa

            # Important! Cleanup: remove the certificate and provisioning profile from the runner!
            - name: Clean up keychain and provisioning profile
              if: ${{ always() }}
              run: |
                  security delete-keychain $RUNNER_TEMP/app-signing.keychain-db
                  rm ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision
